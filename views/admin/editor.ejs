<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><%= pageTitle %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/public/style.css">
</head>
<body class="bg-gray-100">
    <%- include('../partials/admin-header') %>
    <main class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6"><%= pageTitle %></h1>

        <form action="<%= post ? '/admin/posts/edit/' + post.id : '/admin/posts' %>" method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Main Content Column -->
            <div class="md:col-span-2 space-y-6">
                <div class="card">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" id="title" name="title" value="<%= post ? post.title : '' %>" required class="form-input">
                </div>
                <div class="card">
                    <label for="slug" class="form-label">Slug (URL)</label>
                    <input type="text" id="slug" name="slug" value="<%= post ? post.slug : '' %>" required class="form-input">
                </div>
                <div class="card">
                    <label for="excerpt" class="form-label">Excerpt</label>
                    <textarea id="excerpt" name="excerpt" rows="3" class="form-input"><%= post ? post.excerpt : '' %></textarea>
                </div>
                <div class="card">
                    <label for="body" class="form-label">Body (Markdown)</label>
                    <textarea id="body" name="body" rows="15" class="form-input font-mono"><%= post ? post.body : '' %></textarea>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-2">Live Preview</h3>
                    <div id="preview" class="prose max-w-none p-4 border rounded-md bg-gray-50 min-h-[100px]"></div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="md:col-span-1 space-y-6">
                <div class="card">
                    <label for="status" class="form-label">Status</label>
                    <select id="status" name="status" class="form-input">
                        <option value="draft" <%= post && post.status === 'draft' ? 'selected' : '' %>>Draft</option>
                        <option value="published" <%= post && post.status === 'published' ? 'selected' : '' %>>Published</option>
                    </select>
                </div>
                <div class="card">
                    <label for="categories" class="form-label">Categories</label>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <% categories.forEach(cat => { %>
                            <div class="flex items-center">
                                <input type="checkbox" name="categories" value="<%= cat.id %>" id="cat-<%= cat.id %>" class="h-4 w-4"
                                <%= post && post.categories.some(pc => pc.categoryId === cat.id) ? 'checked' : '' %>>
                                <label for="cat-<%= cat.id %>" class="ml-2 text-gray-700"><%= cat.name %></label>
                            </div>
                        <% }) %>
                    </div>
                </div>
                <div class="card">
                    <label for="coverImage" class="form-label">Cover Image</label>
                    <input type="file" id="coverImage" name="coverImage" class="form-input">
                    <% if (post && post.coverImageUrl) { %>
                        <img src="<%= post.coverImageUrl %>" alt="Cover" class="mt-4 rounded-md max-h-40">
                    <% } %>
                </div>
                <div class="card" id="sources-container">
                    <label class="form-label">Sources</label>
                    <% if (post && post.sources && post.sources.length) { %>
                        <% post.sources.forEach(source => { %>
                            <div class="flex gap-2 mb-2 source-item">
                                <input type="text" name="source_labels" placeholder="Label" value="<%= source.label %>" class="form-input flex-1">
                                <input type="url" name="source_urls" placeholder="URL" value="<%= source.url %>" class="form-input flex-1">
                                <button type="button" class="btn-danger remove-source">-</button>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="flex gap-2 mb-2 source-item">
                            <input type="text" name="source_labels" placeholder="Label" class="form-input flex-1">
                            <input type="url" name="source_urls" placeholder="URL" class="form-input flex-1">
                            <button type="button" class="btn-danger remove-source">-</button>
                        </div>
                    <% } %>
                    <button type="button" id="add-source" class="btn-secondary mt-2">Add Source</button>
                </div>
                <button type="submit" class="w-full btn-primary">Save Post</button>
            </div>
        </form>
    </main>

    <script>
        const bodyTextarea = document.getElementById('body');
        const previewDiv = document.getElementById('preview');
        
        // Convert markdown on load
        previewDiv.innerHTML = '<%= marked.parse(post ? post.body.replace(/\r\n/g, "\\n") : "") %>';

        // Update preview on input
        bodyTextarea.addEventListener('input', () => {
            previewDiv.innerHTML = '<%= marked.parse(" ") %>'.replace(' ', bodyTextarea.value);
        });

        // Auto-generate slug from title
        const titleInput = document.getElementById('title');
        const slugInput = document.getElementById('slug');
        titleInput.addEventListener('input', () => {
            slugInput.value = titleInput.value.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
        });

        // Handle dynamic sources
        const sourcesContainer = document.getElementById('sources-container');
        document.getElementById('add-source').addEventListener('click', () => {
            const newItem = document.createElement('div');
            newItem.className = 'flex gap-2 mb-2 source-item';
            newItem.innerHTML = `
                <input type="text" name="source_labels" placeholder="Label" class="form-input flex-1">
                <input type="url" name="source_urls" placeholder="URL" class="form-input flex-1">
                <button type="button" class="btn-danger remove-source">-</button>
            `;
            sourcesContainer.insertBefore(newItem, document.getElementById('add-source'));
        });

        sourcesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-source')) {
                e.target.parentElement.remove();
            }
        });
    </script>
</body>
</html>